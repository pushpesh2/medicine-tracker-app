name: Build Android APK

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive

    # -------------------------------
    # Cache the .buildozer folder
    # -------------------------------
    - name: Cache Buildozer
      uses: actions/cache@v4
      with:
        path: ./.buildozer
        key: buildozer-${{ runner.os }}-${{ hashFiles('**/buildozer.spec') }}
        restore-keys: |
          buildozer-${{ runner.os }}-

    # -------------------------------
    # Build APK using Buildozer Docker
    # -------------------------------
    - name: Build APK using Buildozer Docker
      uses: addnab/docker-run-action@v3
      with:
        image: kivy/buildozer:latest
        options: --workdir /app -v ${{ github.workspace }}:/app
        run: |
          set -e

          # Show Python and Buildozer versions
          python --version
          buildozer --version

          # Ensure .buildozer folder exists
          mkdir -p /app/.buildozer

          # Build the APK (debug)
          buildozer android debug

    # -------------------------------
    # Upload APK as artifact
    # -------------------------------
    - name: Upload debug APK
      uses: actions/upload-artifact@v4
      with:
        name: medicinetracker-debug-apk
        path: ./.buildozer/android/platform/build/dists/medicinetracker/bin/*.apk