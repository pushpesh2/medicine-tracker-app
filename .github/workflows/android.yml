name: Build Android APK

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive

    - name: Build APK in Docker
      uses: addnab/docker-run-action@v4
      with:
        image: python:3.10-slim
        options: --workdir /app -v ${{ github.workspace }}:/app
        run: |
          set -e

          # Install system dependencies
          apt-get update
          apt-get install -y \
            git curl unzip zip openjdk-17-jdk autoconf automake \
            autoconf-archive m4 libtool libtool-bin pkg-config \
            zlib1g-dev libffi-dev libssl-dev libncurses6 cmake wget

          # Install Buildozer and Cython
          pip install --upgrade pip
          pip install buildozer==1.5.0 cython

          # Setup Android SDK directories
          export ANDROID_HOME=/app/.buildozer/android/platform/android-sdk
          export ANDROID_SDK_ROOT=$ANDROID_HOME
          export ANDROID_NDK_HOME=/app/.buildozer/android/platform/android-ndk-r25b
          export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH

          mkdir -p $ANDROID_HOME/cmdline-tools
          cd $ANDROID_HOME/cmdline-tools

          # Download Android command line tools
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline-tools.zip
          unzip -q cmdline-tools.zip
          mv cmdline-tools latest

          # Accept licenses & install SDK packages
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
            "platform-tools" \
            "platforms;android-33" \
            "build-tools;33.0.2" \
            "ndk;25.2.9519653"

          # Build APK
          buildozer android debug