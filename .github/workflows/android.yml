name: Build Android APK

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Build APK using Buildozer Docker
      uses: addnab/docker-run-action@v3
      with:
        image: kivy/buildozer:latest
        options: --workdir /app -v ${{ github.workspace }}:/app
        run: |
          set -e

          # Force non-interactive mode (CI safe)
          export BUILD_USER=root
          export BUILD_NO_INTERACTIVE=1

          # Show Python/Buildozer versions
          python --version
          buildozer --version

          # Ensure .buildozer folder exists
          mkdir -p /app/.buildozer

          # Clean previous builds (optional)
          buildozer android clean

          # Build the APK (debug)
          buildozer android debug

          # Optional: move the APK to workspace for upload
          mkdir -p /app/dist
          cp bin/*/*.apk /app/dist/
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: medicinetracker-apk
        path: dist/