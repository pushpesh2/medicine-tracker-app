name: Build Android APK (Buildozer)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------
      # 1️⃣ Checkout
      # -------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------
      # 2️⃣ HARD CLEAN (MANDATORY)
      # -------------------------------
      - name: Clean old build files
        run: |
          sudo rm -rf .venv
          sudo rm -rf .buildozer
          sudo rm -rf bin
          sudo rm -rf ~/.buildozer
          sudo rm -rf ~/.cache/buildozer
          sudo rm -rf ~/.cache/pip

      # -------------------------------
      # 3️⃣ Cache Buildozer (FAST)
      # -------------------------------
      - name: Cache Buildozer
        uses: actions/cache@v4
        with:
          path: |
            ~/.buildozer
            ~/.cache/pip
          key: buildozer-${{ runner.os }}-${{ hashFiles('buildozer.spec') }}

      # -------------------------------
      # 4️⃣ Build APK (NO ROOT PROMPT)
      # -------------------------------
      - name: Build APK using Docker
        run: |
          docker run --rm \
            -u $(id -u):$(id -g) \
            -v "$PWD:/app" \
            -v "$HOME/.buildozer:/home/user/.buildozer" \
            kivy/buildozer \
            buildozer android debug

      # -------------------------------
      # 5️⃣ Upload APK
      # -------------------------------
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: MedicineTracker-APK
          path: bin/*.apk
          if-no-files-found: error